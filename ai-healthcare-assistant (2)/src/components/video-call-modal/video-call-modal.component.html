<div class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 animate-fade-in backdrop-blur-sm">
  <div class="relative bg-slate-800 w-full h-full flex flex-col items-center justify-center text-white">

    <!-- Video Feed container -->
    <div class="absolute inset-0 w-full h-full">
      <!-- 
        Use opacity instead of display:none to ensure the video element is always in the DOM and layout,
        preventing the race condition where `videoPlayer` is undefined in `ngAfterViewInit`.
        The overlays will correctly cover this element when it's not supposed to be visible.
      -->
      <video #videoPlayer autoplay playsinline class="w-full h-full object-cover transition-opacity duration-300" 
             [class.opacity-100]="callStatus() === 'connected' && !isVideoOff()"
             [class.opacity-0]="callStatus() !== 'connected' || isVideoOff()"></video>

      <!-- Connecting Spinner -->
      @if(callStatus() === 'connecting') {
        <div class="absolute inset-0 w-full h-full flex flex-col items-center justify-center bg-slate-900">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mb-4"></div>
            <p>{{ languageService.translationsMap()['connecting'] }}</p>
        </div>
      }

      <!-- Error State Overlay -->
      @if(callStatus() === 'error') {
        <div class="absolute inset-0 w-full h-full flex flex-col items-center justify-center bg-slate-900 p-4 text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-20 w-20 text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
            </svg>
            <h3 class="text-lg font-semibold mb-2">Media Access Error</h3>
            <p class="text-red-400 max-w-sm">{{ errorMessage() }}</p>
        </div>
      }

      <!-- Video Off State Overlay -->
      @if(callStatus() === 'connected' && isVideoOff()) {
        <div class="absolute inset-0 w-full h-full flex flex-col items-center justify-center bg-slate-900 p-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-20 w-20 text-slate-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.82m5.84-2.56a14.953 14.953 0 00-4.13-1.52m-2.458 5.41a14.923 14.923 0 01-4.244-3.17M15.59 14.37A14.923 14.923 0 0121.2 13.82a14.923 14.923 0 01-4.244 3.17M8.828 14.37a6 6 0 01-5.84-7.38v-4.82" />
          </svg>
           <p class="text-center text-slate-400">Video is off</p>
        </div>
      }
    </div>

    <!-- Controls -->
    <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black/70 via-black/50 to-transparent">
        <div class="flex items-center justify-center space-x-6">
            <!-- Mute Button -->
            <button (click)="toggleAudio()" class="w-16 h-16 rounded-full flex items-center justify-center transition-colors" [class.bg-white/20]="!isMuted()" [class.hover:bg-white/30]="!isMuted()" [class.bg-red-500]="isMuted()" [class.hover:bg-red-600]="isMuted()">
                @if (isMuted()) {
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd" /><path stroke-linecap="round" stroke-linejoin="round" d="M17 14l-2-2m0 0l-2-2m2 2l-2 2m2 2l2 2" /></svg>
                } @else {
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                }
            </button>
            <!-- Video Off Button -->
            <button (click)="toggleVideo()" class="w-16 h-16 rounded-full flex items-center justify-center transition-colors" [class.bg-white/20]="!isVideoOff()" [class.hover:bg-white/30]="!isVideoOff()" [class.bg-red-500]="isVideoOff()" [class.hover:bg-red-600]="isVideoOff()">
                @if(isVideoOff()) {
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /><path stroke-linecap="round" stroke-linejoin="round" d="M4 4l16 16" /></svg>
                } @else {
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                }
            </button>
            <!-- End Call Button -->
            <button (click)="endCall()" class="w-20 h-16 rounded-full flex items-center justify-center bg-red-600 hover:bg-red-700 transition-colors">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 8l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M5 3a2 2 0 00-2 2v1c0 8.284 6.716 15 15 15h1a2 2 0 002-2v-3.28a1 1 0 00-.684-.948l-4.493-1.498a1 1 0 00-1.21.502l-1.13 2.257a11.042 11.042 0 01-5.516-5.517l2.257-1.128a1 1 0 00.502-1.21L9.228 3.683A1 1 0 008.279 3H5z" /></svg>
            </button>
        </div>
        <button (click)="endCall()" class="mx-auto mt-6 block text-sm text-slate-300 hover:underline">{{ languageService.translationsMap()['endCall'] }}</button>
    </div>

  </div>
</div>