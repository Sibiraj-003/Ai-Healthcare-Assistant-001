<div class="flex" [class.justify-end]="isUser()" [class.justify-start]="!isUser()">
  <div class="max-w-sm md:max-w-lg lg:max-w-xl">
    <div class="px-4 py-3 rounded-2xl"
        [class.bg-blue-500]="isUser()"
        [class.text-white]="isUser()"
        [class.animate-slide-in-right]="isUser()"
        [class.bg-slate-200]="!isUser()"
        [class.dark:bg-slate-700]="!isUser()"
        [class.text-slate-800]="!isUser()"
        [class.dark:text-slate-200]="!isUser()"
        [class.animate-slide-in-left]="!isUser()"
        [class.long-bot-message]="!isUser()">
      
      @for(block of renderedBlocks(); track $index) {
        @if (block.type === 'html') {
          <div class="prose prose-sm dark:prose-invert max-w-none" [innerHTML]="block.content"></div>
        } @else if (block.type === 'options' && message().isActionable !== false) {
          <div class="mt-3 mb-2 flex flex-wrap gap-2 items-center not-prose">
            @for(option of block.content; track option) {
              <button 
                (click)="toggleOption(option)"
                class="px-3 py-1.5 text-sm font-medium rounded-full transition-all duration-200 border-2"
                [class.bg-blue-500]="isSelected(option)"
                [class.text-white]="isSelected(option)"
                [class.border-blue-500]="isSelected(option)"
                [class.bg-white]="!isSelected(option)"
                [class.dark:bg-slate-800]="!isSelected(option)"
                [class.text-slate-700]="!isSelected(option)"
                [class.dark:text-slate-200]="!isSelected(option)"
                [class.border-slate-300]="!isSelected(option)"
                [class.dark:border-slate-600]="!isSelected(option)"
                [class.hover:bg-slate-100]="!isSelected(option)"
                [class.dark:hover:bg-slate-700]="!isSelected(option)">
                {{ option }}
              </button>
            }
          </div>
        } @else if (block.type === 'actions' && message().isActionable !== false) {
           <div class="mt-3 mb-2 flex flex-wrap gap-2 items-center not-prose">
            @for(action of block.content; track action) {
              <button 
                (click)="actionClick.emit(action)"
                class="px-4 py-2 text-sm font-medium rounded-lg transition-all duration-200 border-2 bg-slate-50 dark:bg-slate-800 text-slate-700 dark:text-slate-200 border-slate-300 dark:border-slate-600 hover:border-blue-500 dark:hover:border-blue-500 hover:text-blue-600 dark:hover:text-blue-400 focus:outline-none ring-2 ring-transparent focus:ring-blue-500">
                {{ action }}
              </button>
            }
          </div>
        }
      }
    </div>
    
    @if (!isUser() && plainTextContent()) {
      <div class="mt-2 flex items-center justify-end space-x-2 animate-fade-in">
        @if (ttsSupported()) {
          <button (click)="togglePlayPause()"
            class="p-2 rounded-full text-slate-500 dark:text-slate-400 hover:bg-slate-300 dark:hover:bg-slate-600 hover:text-slate-700 dark:hover:text-slate-200 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-slate-900 focus:ring-blue-500"
            [attr.aria-label]="isCurrentlyPlaying() ? 'Stop reading' : 'Read message aloud'">
            @if (isCurrentlyPlaying()) {
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
              </svg>
            } @else {
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
              </svg>
            }
          </button>
        }
        <button (click)="copyContent()"
          class="p-2 rounded-full text-slate-500 dark:text-slate-400 hover:bg-slate-300 dark:hover:bg-slate-600 hover:text-slate-700 dark:hover:text-slate-200 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-slate-900 focus:ring-blue-500"
          aria-label="Copy message text">
          @if(copyStatus() === 'copied') {
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
          } @else {
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
          }
        </button>
      </div>
    }
  </div>
</div>
